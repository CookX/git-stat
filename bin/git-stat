#!/usr/bin/env node

/**
 * Git 代码行数统计（以人为维度）
 * todo: 支持分支切换
 */

const fs = require('fs')
const path = require('path')
const execFileSync = require('child_process').execFileSync
const execSync = require('child_process').execSync
const program = require('commander')

/**
 * Usage
 */
// gitstat --help，命令列表
program
  .version(require('../package').version)
  .usage('<git-repo-name/config> <dest-name>')
  .option('--since', 'config start date, YYYY-MM-DD')
  .option('--until', 'config end date, YYYY-MM-DD')
  .option('-ui', 'create a server to do visual operation')

// 解析 process.argv 数组： [node目录, 执行文件目录, 参数]
program.parse(process.argv)

/**
 * Settings
 */
// 从配置读取代码仓库、开始日期、结束日期、输出文件等信息
var gitRepo = program.args[0]
const config = require(path.join(__dirname, gitRepo))
const repositories = config.repositories || program.args[0]
const startDate = config.startDate || program.args[3]
const endDate = config.endDate || program.args[4]
const distFile = config.distFile  || program.args[1]

const distFilePath = path.join(__dirname, '../', distFile)
fs.writeFileSync(distFilePath, '# 代码提交量统计\n## 详情')

// 代码行数总计（以人为维度统计）
var totalStatObj = {'## 汇总': {}}

// 循环获取git代码提交情况
repositories.forEach((item, index) => {
	const dirName = item.address.replace(/^.*\:\d+\/((\w|\-|\/)+)\.git/g, '$1')
	const changeName = '../.projects/' + dirName
	item.branch = item.branch || 'master'

  const projectsAbsoluteDir = path.join(__dirname, changeName)
	// 拉取更新代码仓库，切换分支
	if (fs.existsSync(projectsAbsoluteDir)) {
		execSync(`cd ${projectsAbsoluteDir}; git checkout ${item.branch};git pull origin ${item.branch};`)
	} else {
		execSync(`git clone -b ${item.branch} ${item.address} ${changeName};`)
	}

	// 统计代码
	const statData = execFileSync(
		path.join(__dirname, '../index.sh'), [ startDate, endDate], {
			cwd: path.join(__dirname, changeName),
		}).toString()

	// 组装对象
	const statObj = eval("(" + statData + ")")
	const distObj = {}
	distObj[dirName] = statObj

	// 打印输出
	dist(distObj)

	// 生成总计对象
	Object.keys(statObj).forEach(element => {
		if (!totalStatObj['## 汇总'][element]) {
			totalStatObj['## 汇总'][element] = [0, 0, 0]
		}
		totalStatObj['## 汇总'][element][0] += statObj[element][0] || 0
		totalStatObj['## 汇总'][element][1] += statObj[element][1] || 0
		totalStatObj['## 汇总'][element][2] += statObj[element][2] || 0
	})

	// 重置&清理
	// execSync(`rm -rf ${changeName}`)
})

// 输出每人代码总行数
dist(totalStatObj)

// 打印输出md
function dist (obj) {
	for (let key in obj) {
		// 打印当前项目统计
		fs.appendFileSync(distFilePath, `\n${key}：\n` +
		'user name | added lines | removed lines | total lines\n' +
		'---- | --- | --- | ---\n')

		Object.keys(obj[key]).forEach(element => {
			// 去除提交量为0的
			if (obj[key][element][0] === obj[key][element][1]  && obj[key][element][1] === obj[key][element][2] && obj[key][element][0] === 0) return
			fs.appendFileSync(distFilePath, `${element} | ${obj[key][element][0] || 0} | ${obj[key][element][1] || 0} | ${obj[key][element][2] || 0}\n`)
		})
	}
}